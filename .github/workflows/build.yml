name: Build Extension

on:
  release:
    types: [published, created]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: â„¹ï¸ Debug info
        run: |
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Release name: ${{ github.event.release.name }}"
          echo "Release ID: ${{ github.event.release.id }}"
          echo "Repository: ${{ github.repository }}"

      - name: ğŸ—ï¸ Build Firefox extension
        run: npm run pack:firefox

      - name: ğŸ—ï¸ Build Chrome extension
        run: npm run pack:chrome

      - name: ğŸ“ Prepare release assets
        run: |
          TAG=${{ github.event.release.tag_name }}
          echo "Preparing assets for tag: $TAG"
          
          # Create release directory
          mkdir -p release-assets
          
          # Find and rename Firefox extension (handles any naming pattern)
          FIREFOX_ZIP=$(find web-ext-artifacts/firefox -name "*.zip" -type f | head -n 1)
          if [ -n "$FIREFOX_ZIP" ] && [ -f "$FIREFOX_ZIP" ]; then
            cp "$FIREFOX_ZIP" "release-assets/comics-manga-downloader-${TAG}-firefox.zip"
            echo "âœ“ Firefox extension prepared: release-assets/comics-manga-downloader-${TAG}-firefox.zip"
            echo "  Source: $FIREFOX_ZIP"
          else
            echo "âš  Warning: Firefox extension zip not found in web-ext-artifacts/firefox/"
            ls -la web-ext-artifacts/firefox/ || echo "Directory does not exist"
          fi
          
          # Find and rename Chrome extension
          if [ -f web-ext-artifacts/chrome/chrome-extension.zip ]; then
            cp web-ext-artifacts/chrome/chrome-extension.zip "release-assets/comics-manga-downloader-${TAG}-chrome.zip"
            echo "âœ“ Chrome extension prepared: release-assets/comics-manga-downloader-${TAG}-chrome.zip"
          else
            echo "âš  Warning: Chrome extension zip not found"
            ls -la web-ext-artifacts/chrome/ || echo "Directory does not exist"
          fi
          
          # List all files to be uploaded
          echo ""
          echo "=== Files to upload ==="
          ls -lh release-assets/ || echo "No files found in release-assets/"
          
          # Verify files exist before upload
          if [ ! -f "release-assets/comics-manga-downloader-${TAG}-firefox.zip" ] || [ ! -f "release-assets/comics-manga-downloader-${TAG}-chrome.zip" ]; then
            echo "âŒ Error: One or more required files are missing!"
            exit 1
          fi

      - name: ğŸ“¤ Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            release-assets/comics-manga-downloader-${{ github.event.release.tag_name }}-firefox.zip
            release-assets/comics-manga-downloader-${{ github.event.release.tag_name }}-chrome.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false
