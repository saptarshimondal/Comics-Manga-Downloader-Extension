name: Build Extension

on:
  push:
    tags:
      - 'v*'
      - 'comics-manga-downloader-v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üì¶ Install dependencies
        run: npm ci

      - name: ‚ÑπÔ∏è Debug info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"
          echo "Ref: ${{ github.ref }}"

      - name: üèóÔ∏è Build Firefox extension
        run: npm run pack:firefox

      - name: üèóÔ∏è Build Chrome extension
        run: npm run pack:chrome

      - name: üìù Rename files with tag
        id: prepare-assets
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Preparing assets for tag: $TAG"
          
          # Extract version from tag (handle both v1.4.1 and comics-manga-downloader-v1.4.1)
          if [[ "$TAG" == comics-manga-downloader-v* ]]; then
            VERSION_TAG="v${TAG#comics-manga-downloader-v}"
          elif [[ "$TAG" == v* ]]; then
            VERSION_TAG="$TAG"
          else
            VERSION_TAG="$TAG"
          fi
          
          echo "Using version tag: $VERSION_TAG"
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          
          # Create release directory
          mkdir -p release-assets
          
          # Find and rename Firefox extension (handles any naming pattern)
          FIREFOX_ZIP=$(find web-ext-artifacts/firefox -name "*.zip" -type f | head -n 1)
          if [ -n "$FIREFOX_ZIP" ] && [ -f "$FIREFOX_ZIP" ]; then
            cp "$FIREFOX_ZIP" "release-assets/comics-manga-downloader-${VERSION_TAG}-firefox.zip"
            echo "‚úì Firefox extension: release-assets/comics-manga-downloader-${VERSION_TAG}-firefox.zip"
          else
            echo "‚ùå Error: Firefox extension zip not found"
            ls -la web-ext-artifacts/firefox/ || echo "Directory does not exist"
            exit 1
          fi
          
          # Find and rename Chrome extension
          if [ -f web-ext-artifacts/chrome/chrome-extension.zip ]; then
            cp web-ext-artifacts/chrome/chrome-extension.zip "release-assets/comics-manga-downloader-${VERSION_TAG}-chrome.zip"
            echo "‚úì Chrome extension: release-assets/comics-manga-downloader-${VERSION_TAG}-chrome.zip"
          else
            echo "‚ùå Error: Chrome extension zip not found"
            ls -la web-ext-artifacts/chrome/ || echo "Directory does not exist"
            exit 1
          fi
          
          echo "Files ready for upload:"
          ls -lh release-assets/

      - name: üì§ Create release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ steps.prepare-assets.outputs.version_tag || github.ref_name }}
          files: |
            release-assets/comics-manga-downloader-*
          draft: false
          prerelease: false
          make_latest: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
